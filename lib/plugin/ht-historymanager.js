!function(F,V,W){"use strict";var P="ht",n=F[P],l=n.Default,R=l.def,y=l.getInternal();n.HistoryManager=function(q){this._histories=[],this.setDataModel(q)},R(n.HistoryManager,V,{ms_ac:["dataModel","histories","historyIndex","maxHistoryCount","disabled"],ms_fire:1,_historyIndex:-1,_betweenTransaction:0,_maxHistoryCount:200,_disabled:!1,ignoredPropertyMap:{imageLoaded:!0,children:!0,attaches:!0,shape:!0,childChange:!0,agentChange:!0,sourceAgent:!0,targetAgent:!0,edgeGroup:!0,"*":!0},ignoreDataModelPropertyMap:{},beginInteraction:function(){this.beginTransaction()},endInteraction:function(){this.endTransaction()},beginTransaction:function(){if(!this._disabled){var P=this;P._betweenTransaction++,1===P._betweenTransaction&&(P._transactionHistories={})}},endTransaction:function(){if(!this._disabled){var T=this,t=T._histories;if(T._betweenTransaction>0&&T._betweenTransaction--,0===T._betweenTransaction){if(T._transactionHistories){var c=[];for(var G in T._transactionHistories)c.push(T._transactionHistories[G]);c.length&&(t=t.slice(0,T._historyIndex+1),t.push(c),t.length>T._maxHistoryCount&&(t=t.slice(t.length-T._maxHistoryCount)),T.setHistories(t),T.setHistoryIndex(t.length-1,!0))}delete T._transactionHistories}}},setDataModel:function(z){var B=this,Q=B._dataModel;Q!==z&&(Q&&(delete Q._historyManager,Q.ump(B.handleDataModelPropertyChange,B),Q.umm(B.$5p,B),Q.umd(B.$6p,B),Q.removeHierarchyChangeListener(B.handleHierarchyChange,B),Q.removeIndexChangeListener(B.handleIndexChange,B)),B._dataModel=z,z&&(z._historyManager=B,z.mp(B.handleDataModelPropertyChange,B),z.mm(B.$5p,B),z.md(B.$6p,B),z.addHierarchyChangeListener(B.handleHierarchyChange,B),z.addIndexChangeListener(B.handleIndexChange,B)),B.fp("dataModel",Q,z),B.clear())},setHistoryIndex:function(J,Y){var z=this,F=z._historyIndex,R=z._histories.length;if(-1>J?J=-1:J>=R&&(J=R-1),F!==J){if(!Y){var l=J-F;l>0?z.$2p(l):0>l&&z.$1p(-l)}z._historyIndex=J,z.fp("historyIndex",F,J),z.dataModel&&z.dataModel.onHistoryManagerChanged()}},setMaxHistoryCount:function(L){var O=this,g=O._histories,x=O._maxHistoryCount;(!L||0>=L)&&(L=10),x!==L&&(O._maxHistoryCount=L,O.fp("maxHistoryCount",x,L),g.length>L&&O.clear())},cloneValue:function(I){return n.Default.clone(I)},isPropertyUndoable:function(g){return g&&!this.ignoredPropertyMap[g]},isIndexUndoable:function(){return!1},isDataModelPropertyUndoable:function(x){return x&&!this.ignoreDataModelPropertyMap[x]},$5p:function(G){this.handleChange(G,G.kind)},$6p:function(F){this.handleChange(F,"property")},handleHierarchyChange:function(F){this.handleChange(F,"hierarchy")},handleIndexChange:function(I){this.handleChange(I,"index")},handleDataModelPropertyChange:function(_){this.handleChange(_,"dataModelProperty")},toChildrenInfo:function(q){var D={};return D.data=q,D.children=[],q.eachChild(function(r){D.children.push(this.toChildrenInfo(r))},this),D},restoreChildren:function(J){var Y=J.data;J.children.forEach(function(o){var Q=o.data;Q.getParent()!==Y&&Y.addChild(Q),this._dataModel.contains(Q)||this._dataModel.add(Q),this.restoreChildren(o)},this)},handleChange:function(O,w){var N=this;if(!(N._disabled||N._isUndoRedoing||l.loadingRefGraph)){var y,A=(N._histories,O.data),q=O.property;if(!A||!(A._refGraph||A instanceof n.RefGraph)){if("property"===w)N.isPropertyUndoable(q,A)&&(y={kind:w,data:A,property:q,oldValue:N.cloneValue(O.oldValue,A,q),newValue:N.cloneValue(O.newValue,A,q),event:O});else if("hierarchy"===w||"index"===w&&N.isIndexUndoable(O))y={kind:w,data:A,oldIndex:O.oldIndex,newIndex:O.newIndex,event:O};else if("clear"===w)y={kind:w,json:O.json,event:O};else if("add"===w){if(y={kind:w,data:A,event:O,childrenInfo:this.toChildrenInfo(A),parent:A.getParent()},y.parent){var X=N._dataModel.getSiblings(A);y.siblingsIndex=X.indexOf(A)}A instanceof n.Node&&(y.host=A.getHost(),y.attaches=A.getAttaches()?A.getAttaches().toArray():W),A instanceof n.Edge&&(y.source=A.getSource(),y.target=A.getTarget())}else"remove"===w?y={kind:w,data:A,event:O}:"dataModelProperty"===w&&N.isDataModelPropertyUndoable(q,A)&&(y={kind:w,property:q,oldValue:N.cloneValue(O.oldValue,A,q),newValue:N.cloneValue(O.newValue,A,q),event:O});N.addHistory(y)}}},addHistory:function(o){var Y=this;if(o)if(Y._betweenTransaction){var e=(o.data?o.data._id:0)+"_"+o.kind+"_"+o.property;if("property"===o.kind||"dataModelProperty"===o.kind){var X=Y._transactionHistories[e];X&&(o.oldValue=X.oldValue)}Y._transactionHistories[e]=o}else{var F=Y._histories;F=F.slice(0,Y._historyIndex+1),F.push([o]),F.length>Y._maxHistoryCount&&(F=F.slice(F.length-Y._maxHistoryCount)),Y.setHistories(F),Y.setHistoryIndex(F.length-1,!0)}},canUndo:function(){return!this._disabled&&this._historyIndex>=0&&this._historyIndex<this._histories.length},canRedo:function(){return!this._disabled&&this._historyIndex>=-1&&this._historyIndex<this._histories.length-1},undo:function(F){(!F||0>=F)&&(F=1),this.setHistoryIndex(this._historyIndex-F)},$1p:function(k){if(this.canUndo()){var V,O=this,c=O._dataModel,U=O._histories,h=O._historyIndex,$=0;for(O._isUndoRedoing=!0,l.setIsolating(!0);k>0;){if(h>=0&&h<U.length){$++,V=U[h],h--;for(var G=V.length-1;G>=0;G--){var H=V[G],M=H.kind,x=H.data,t=H.property,Y=H.event,v=this.cloneValue(H.oldValue,x,t);if(H.undo)H.undo();else if("add"===M)c.remove(x,{keepChildren:!0});else if("remove"===M)c.contains(x)||c.add(x,Y.rootsIndex,Y.datasIndex);else if("clear"===M)c.deserialize(l.clone(H.json));else if("property"===M)if("parent"===t)v?v.addChild(x,Y.oldIndex):(x.setParent(v),Y.oldIndex>=0&&c.moveTo(x,Y.oldIndex));else{var d=null;0===t.indexOf("a:")?(d="attr",t=t.replace("a:","")):0===t.indexOf("s:")?(d="style",t=t.replace("s:","")):0===t.indexOf("f:")&&(d="field",t=t.replace("f:","")),y.setPropertyValue(x,d,t,v)}else if("dataModelProperty"===M){var d=null;0===t.indexOf("a:")?(d="attr",t=t.replace("a:","")):0===t.indexOf("s:")?(d="style",t=t.replace("s:","")):0===t.indexOf("f:")&&(d="field",t=t.replace("f:","")),y.setPropertyValue(c,d,t,v)}else"hierarchy"===M?c.moveTo(x,H.oldIndex):"index"===M&&c.moveToIndex(x,H.oldIndex)}}k--}l.setIsolating(!1),delete O._isUndoRedoing,O.afterUndo($)}},afterUndo:function(){},redo:function(f){(!f||0>=f)&&(f=1),this.setHistoryIndex(this._historyIndex+f)},$2p:function(b){if(this.canRedo()){var x,H=this,E=H._dataModel,z=H._histories,o=H._historyIndex,q=0;for(H._isUndoRedoing=!0,l.setIsolating(!0);b>0;){if(o>=-1&&o<z.length-1){q++,o++,x=z[o];for(var Z=0;Z<x.length;Z++){var Q=x[Z],h=Q.kind,k=Q.data,M=Q.property,r=Q.event,a=this.cloneValue(Q.newValue,k,M);if(Q.redo)Q.redo();else if("add"===h)Q.parent&&!k.getParent()&&Q.parent.addChild(k,Q.siblingsIndex),E.contains(k)||E.add(k,r.rootsIndex,r.datasIndex),this.restoreChildren(Q.childrenInfo),k instanceof n.Node&&(k.setHost(Q.host),Q.attaches&&Q.attaches.forEach(function(j){j.setHost(k)})),k instanceof n.Edge&&(k.setSource(Q.source),k.setTarget(Q.target));else if("remove"===h)E.remove(k);else if("clear"===h)E.clear();else if("property"===h)if("parent"===M)a?a.addChild(k,r.newIndex):(k.setParent(a),r.newIndex>=0&&E.moveTo(k,r.newIndex));else{var g=null;0===M.indexOf("a:")?(g="attr",M=M.replace("a:","")):0===M.indexOf("s:")?(g="style",M=M.replace("s:","")):0===M.indexOf("f:")&&(g="field",M=M.replace("f:","")),y.setPropertyValue(k,g,M,a)}else if("dataModelProperty"===h){var g=null;0===M.indexOf("a:")?(g="attr",M=M.replace("a:","")):0===M.indexOf("s:")?(g="style",M=M.replace("s:","")):0===M.indexOf("f:")&&(g="field",M=M.replace("f:","")),y.setPropertyValue(E,g,M,a)}else"hierarchy"===h?E.moveTo(k,Q.newIndex):"index"===h&&E.moveToIndex(k,Q.newIndex)}}b--}l.setIsolating(!1),delete H._isUndoRedoing,this.afterRedo(q)}},afterRedo:function(){},clear:function(){this.setHistories([]),this.setHistoryIndex(-1,!0),this._betweenTransaction=0,delete this._transactionHistories}})}("undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:(0,eval)("this"),Object);